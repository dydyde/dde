

<div class="flex h-full w-full bg-[#F9F8F6] overflow-hidden font-sans text-stone-600">
  @if (!store.currentUserId()) {
    <div class="fixed top-4 right-4 z-50 w-80">
      <form (submit)="handleLogin($event)" class="bg-white/90 backdrop-blur-xl border border-stone-200 shadow-lg rounded-xl p-4 space-y-3 text-sm">
        <div class="flex justify-between items-center">
          <div class="font-semibold text-stone-700">Supabase 登录</div>
          @if (isCheckingSession()) { <span class="text-[11px] text-stone-400">检查中...</span> }
        </div>
        <input type="email" placeholder="邮箱" [ngModel]="authEmail()" (ngModelChange)="authEmail.set($event)" [ngModelOptions]="{standalone: true}" name="authEmail" class="w-full border border-stone-200 rounded-lg px-3 py-2 text-sm text-stone-700 bg-white focus:outline-none focus:ring-1 focus:ring-indigo-300" autocomplete="email" required>
        <input type="password" placeholder="密码" [ngModel]="authPassword()" (ngModelChange)="authPassword.set($event)" [ngModelOptions]="{standalone: true}" name="authPassword" class="w-full border border-stone-200 rounded-lg px-3 py-2 text-sm text-stone-700 bg-white focus:outline-none focus:ring-1 focus:ring-indigo-300" autocomplete="current-password" required>
        @if (authError()) {
          <div class="text-xs text-red-500 bg-red-50 border border-red-100 rounded-lg px-3 py-2">{{ authError() }}</div>
        }
        <button type="submit" class="w-full py-2 rounded-lg bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-500 transition disabled:opacity-60" [disabled]="isAuthLoading()">
          @if (isAuthLoading()) { 正在登录... } @else { 登录 }
        </button>
      </form>
    </div>
  }
  
  <!-- Left Sidebar: Project List -->
  <aside class="bg-[#F9F8F6] border-r border-stone-200/50 flex flex-col shrink-0 transition-all duration-75 shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10 overflow-hidden"
         [style.width.px]="isSidebarOpen() ? store.sidebarWidth() : 0"
         [class.w-0]="!isSidebarOpen()">
    
    <!-- Sidebar Header -->
    <div class="mx-6 mt-8 mb-6 flex justify-between items-center min-w-[200px] shrink-0">
      <h1 class="font-bold text-2xl text-stone-800 tracking-tight font-serif">NanoFlow</h1>
      <button (click)="createNewProject()" class="text-stone-400 hover:text-stone-800 hover:bg-stone-200/50 w-8 h-8 flex items-center justify-center rounded-full transition-all text-xl font-light" title="新建项目">+</button>
    </div>

    <!-- Project List -->
    <div class="flex-1 overflow-y-auto px-4 space-y-1 min-w-[240px]">
      @for (proj of store.projects(); track proj.id) {
        <div class="space-y-2">
          <div 
            (click)="selectProject(proj.id)"
            (dblclick)="handleProjectDoubleClick(proj.id, $event)"
            class="px-4 py-3 rounded-lg cursor-pointer transition-all duration-200 group"
            [class.bg-indigo-100/60]="store.activeProjectId() === proj.id"
            [class.text-indigo-900]="store.activeProjectId() === proj.id"
            [class.text-stone-500]="store.activeProjectId() !== proj.id"
            [class.hover:bg-stone-100]="store.activeProjectId() !== proj.id">
            <div class="font-medium text-sm transition-colors">{{ proj.name }}</div>
            @if (store.activeProjectId() === proj.id) {
              <div class="text-[10px] text-indigo-400 mt-1 animate-fade-in leading-relaxed font-mono">
                {{ proj.createdDate | date:'MM/dd' }}
              </div>
            }
          </div>

          @if (expandedProjectId() === proj.id) {
            @if (projectDraft(proj.id); as draft) {
              <div class="mx-4 mt-1 mb-3 p-4 rounded-xl border border-stone-200 bg-white/90 text-xs text-stone-600 space-y-3 shadow-sm cursor-default" (click)="$event.stopPropagation()">
                <div class="flex flex-col gap-1">
                  <label class="font-semibold text-[11px] text-stone-400 uppercase tracking-wide">创建时间</label>
                  <div class="w-full border border-transparent px-3 py-2 text-stone-500">
                    {{ proj.createdDate | date:'yyyy-MM-dd HH:mm' }}
                  </div>
                </div>
                <div class="flex flex-col gap-1">
                  <label class="font-semibold text-[11px] text-stone-400 uppercase tracking-wide">简介</label>
                  @if (isEditingDescription()) {
                    <textarea
                      rows="3"
                      class="w-full border border-stone-200 rounded-lg px-3 py-2 text-stone-600 bg-transparent focus:outline-none focus:ring-1 focus:ring-indigo-300 resize-none"
                      [ngModel]="draft.description"
                      (ngModelChange)="updateProjectDraft(proj.id, 'description', $event)"></textarea>
                    <div class="flex justify-end">
                      <button
                        type="button"
                        class="px-4 py-2 rounded-lg bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-500 transition"
                        (click)="saveProjectDetails(proj.id)">
                        保存
                      </button>
                    </div>
                  } @else {
                    <div 
                      class="w-full border border-transparent px-3 py-2 text-stone-600 whitespace-pre-wrap min-h-[3em] hover:bg-stone-50 rounded-lg transition-colors cursor-text"
                      (dblclick)="handleProjectDoubleClick(proj.id, $event)"
                      title="双击编辑">
                      {{ draft.description || '无简介' }}
                    </div>
                  }
                </div>
              </div>
            }
          }
        </div>
      }
    </div>
    
    <!-- Sidebar Footer -->
    <div class="mx-4 mb-6 min-w-[200px] shrink-0">
      <button (click)="openSettings()" class="w-full py-3 px-4 text-stone-500 hover:text-stone-800 hover:bg-stone-100 rounded-xl text-xs font-medium transition-all flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        全局设置
      </button>
    </div>
  </aside>

  <!-- Sidebar Resizer -->
  <div class="w-1 hover:w-1.5 bg-transparent hover:bg-stone-300 cursor-col-resize transition-all z-50 flex-shrink-0 relative group"
       (mousedown)="startSidebarResize($event)">
       <div class="absolute inset-y-0 left-0 w-px bg-stone-200 group-hover:bg-stone-400 transition-colors"></div>
  </div>

  <!-- Main Content -->
  <main class="flex-1 flex relative bg-[#F9F8F6] responsive-stack overflow-x-hidden"
        [class.h-full]="!store.isMobile()"
        [class.h-auto]="store.isMobile()"
        [class.overflow-hidden]="!store.isMobile()"
        [class.overflow-y-auto]="store.isMobile()">
    @if (store.activeProjectId()) {
      <!-- Text Column -->
      <div class="flex flex-col border-r border-stone-200/60 min-w-[300px] bg-[#F9F8F6]"
           [class.hidden]="store.isMobile() && mobileActiveView() !== 'text'"
           [class.w-full]="store.isMobile()"
           [style.width.%]="store.isMobile() ? 100 : store.textColumnRatio()">
        <!-- Header for Text Column -->
        <div class="h-16 mx-6 mt-6 flex items-center justify-between shrink-0 z-10">
           <div class="flex items-center gap-3">
             <button (click)="toggleSidebar()" class="text-stone-400 hover:text-stone-600 transition-colors p-2 hover:bg-stone-200/50 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
             </button>
             <span class="font-bold text-stone-800 text-lg tracking-tight">文本视图</span>
           </div>
           <!-- Filter -->
           <div class="relative flex items-center gap-2">
             <!-- Mobile Switch Button -->
             @if(store.isMobile()) {
                <button (click)="switchToFlow()" class="bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm whitespace-nowrap">
                    切换流程图
                </button>
             }

             <button 
                (click)="isFilterOpen.set(!isFilterOpen()); $event.stopPropagation()"
                class="flex items-center gap-2 bg-transparent text-xs font-medium text-stone-500 hover:text-indigo-800 transition-colors py-1.5 px-3 rounded-lg hover:bg-indigo-50 border border-transparent active:bg-indigo-100">
                 <span>{{ currentFilterLabel() }}</span>
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 transition-transform duration-200" [class.rotate-180]="isFilterOpen()" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                 </svg>
             </button>
             
             @if (isFilterOpen()) {
                <!-- Backdrop to close -->
                <div class="fixed inset-0 z-40" (click)="isFilterOpen.set(false)"></div>
                
                <!-- Dropdown Menu -->
                <div class="absolute right-0 top-full mt-1 w-48 bg-white/90 backdrop-blur-xl border border-stone-100 rounded-xl shadow-lg z-50 py-1 animate-fade-in overflow-hidden">
                    <div 
                        (click)="store.filterMode.set('all'); isFilterOpen.set(false)"
                        class="px-4 py-2.5 text-xs text-stone-600 hover:bg-indigo-50 hover:text-indigo-900 cursor-pointer flex items-center justify-between group transition-colors">
                        <span>全部任务</span>
                        @if (store.filterMode() === 'all') { <span class="text-indigo-600 font-bold">✓</span> }
                    </div>
                    <div class="h-px bg-stone-100 my-1"></div>
                    @for(root of store.rootTasks(); track root.id) {
                        <div 
                            (click)="store.filterMode.set(root.id); isFilterOpen.set(false)"
                            class="px-4 py-2.5 text-xs text-stone-600 hover:bg-indigo-50 hover:text-indigo-900 cursor-pointer flex items-center justify-between group transition-colors">
                            <span class="truncate">{{root.title}}</span>
                            @if (store.filterMode() === root.id) { <span class="text-indigo-600 font-bold">✓</span> }
                        </div>
                    }
                </div>
             }
           </div>
        </div>
        <app-text-view class="flex-1"
                       [class.overflow-hidden]="!store.isMobile()"
                       [class.overflow-y-auto]="store.isMobile()"></app-text-view>
      </div>

      <!-- Content Resizer -->
      @if(!store.isMobile()) {
        <div class="w-1 hover:w-1.5 bg-transparent hover:bg-stone-300 cursor-col-resize z-20 flex-shrink-0 relative group"
             (mousedown)="startContentResize($event)">
             <div class="absolute inset-y-0 left-0 w-px bg-stone-200 group-hover:bg-stone-400 transition-colors"></div>
        </div>
      }

      <!-- Flow Column -->
      <div class="flex-1 flex flex-col min-w-[300px] relative bg-[#F9F8F6]"
           [class.hidden]="store.isMobile() && mobileActiveView() !== 'flow'"
           [class.w-full]="store.isMobile()">
         <div class="h-16 mx-6 mt-6 flex items-center justify-between shrink-0 z-10">
            <span class="font-bold text-stone-800 text-lg tracking-tight">流程视图</span>
            @if(store.isMobile()) {
                <button (click)="mobileActiveView.set('text')" class="bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm whitespace-nowrap">
                    切换文本
                </button>
            }
         </div>
         <app-flow-view class="flex-1 overflow-hidden"></app-flow-view>
      </div>
    } @else {
      <div class="flex-1 flex items-center justify-center text-stone-300 flex-col gap-6">
        <div class="w-24 h-24 rounded-full bg-stone-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
        </div>
        <p class="font-light tracking-widest text-sm">请选择或创建一个项目</p>
      </div>
    }
  </main>

  <!-- Settings Modal Overlay -->
  @if (showSettings()) {
    <div class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center backdrop-blur-sm" (click)="closeSettings()">
      <div class="bg-white rounded-xl shadow-2xl w-96 p-6 transform transition-all scale-100" (click)="$event.stopPropagation()">
        <h2 class="text-xl font-bold mb-4 text-slate-800">设置</h2>
        
        <div class="space-y-4">
          <div class="rounded-xl border border-stone-200 bg-stone-50/60 p-4 shadow-sm space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-[11px] font-semibold text-stone-400 uppercase tracking-wide">账户</div>
                <div class="text-sm font-semibold text-stone-800">Supabase 登录</div>
              </div>
              <span class="px-2.5 py-1 text-[11px] rounded-full border"
                    [class.bg-emerald-50]="store.currentUserId()"
                    [class.border-emerald-100]="store.currentUserId()"
                    [class.text-emerald-700]="store.currentUserId()"
                    [class.bg-amber-50]="!store.currentUserId()"
                    [class.border-amber-100]="!store.currentUserId()"
                    [class.text-amber-700]="!store.currentUserId()">
                @if (store.currentUserId()) { 已登录 } @else { 未登录 }
              </span>
            </div>

            <div class="text-xs text-stone-500">
              @if (store.currentUserId()) {
                当前账号：{{ sessionEmail() || "Supabase 用户" }}
              } @else {
                登录后可同步云端项目数据。
              }
            </div>

            <div class="flex flex-wrap gap-2">
              @if (store.currentUserId()) {
                <button type="button" (click)="startRelogin()" class="px-3 py-1.5 rounded-lg text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-100 hover:bg-indigo-100 transition">重新登录</button>
                <button type="button" (click)="signOut()" class="px-3 py-1.5 rounded-lg text-xs font-medium bg-red-50 text-red-600 border border-red-100 hover:bg-red-100 transition">退出登录</button>
              } @else {
                <button type="button" (click)="isReloginMode.set(true)" class="px-3 py-1.5 rounded-lg text-xs font-medium bg-indigo-600 text-white hover:bg-indigo-500 transition">立即登录</button>
              }
            </div>

            @if (authError()) {
              <div class="text-xs text-red-500 bg-red-50 border border-red-100 rounded-lg px-3 py-2">{{ authError() }}</div>
            }

            @if (showSettingsAuthForm()) {
              <form (submit)="handleLogin($event)" class="space-y-2 text-sm">
                <div class="space-y-2">
                  <input type="email" placeholder="邮箱" [ngModel]="authEmail()" (ngModelChange)="authEmail.set($event)" [ngModelOptions]="{standalone: true}" name="authEmailSettings" class="w-full border border-stone-200 rounded-lg px-3 py-2 text-sm text-stone-700 bg-white focus:outline-none focus:ring-1 focus:ring-indigo-300" autocomplete="email" required>
                  <input type="password" placeholder="密码" [ngModel]="authPassword()" (ngModelChange)="authPassword.set($event)" [ngModelOptions]="{standalone: true}" name="authPasswordSettings" class="w-full border border-stone-200 rounded-lg px-3 py-2 text-sm text-stone-700 bg-white focus:outline-none focus:ring-1 focus:ring-indigo-300" autocomplete="current-password" required>
                </div>
                <button type="submit" class="w-full py-2 rounded-lg bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-500 transition disabled:opacity-60" [disabled]="isAuthLoading()">
                  @if (isAuthLoading()) { 正在登录... } @else { 登录 }
                </button>
              </form>
            }
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-600 mb-1">布局方向</label>
            <select 
                [value]="store.layoutDirection()" 
                (change)="updateLayoutDirection($event)"
                class="w-full border border-slate-300 rounded px-3 py-2 text-slate-700">
              <option value="ltr">从左到右</option>
              <option value="rtl">从右到左</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-600 mb-1">悬浮窗设置</label>
            <select 
                [value]="store.floatingWindowPref()"
                (change)="updateFloatPref($event)"
                class="w-full border border-slate-300 rounded px-3 py-2 text-slate-700">
              <option value="auto">自动调整</option>
              <option value="fixed">固定位置</option>
            </select>
          </div>

          <div class="pt-4 border-t border-slate-100 space-y-2">
             <h3 class="font-medium text-sm text-slate-500 mb-2">AI 实验室</h3>
             <button (click)="generateImage()" class="w-full py-2 bg-gradient-to-r from-pink-500 to-violet-500 text-white rounded font-medium hover:shadow-lg transition-shadow">
                 AI 绘图
             </button>
             <button (click)="openImageEditor()" class="w-full py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded font-medium hover:shadow-lg transition-shadow">
                 AI 图像编辑
             </button>
          </div>
        </div>
        
        <div class="mt-6 flex justify-end">
          <button (click)="closeSettings()" class="px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-700 transition-colors">关闭</button>
        </div>
      </div>
    </div>
  }
  <!-- New Project Modal -->
  @if(showNewProjectModal()) {
      <div class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center backdrop-blur-sm" (click)="showNewProjectModal.set(false)">
           <div class="bg-white rounded-xl shadow-2xl w-96 p-6" (click)="$event.stopPropagation()">
               <h2 class="text-xl font-bold mb-4">新建项目</h2>
               <input #projName placeholder="项目名称" class="w-full border p-2 rounded mb-4">
               <textarea #projDesc placeholder="项目描述" class="w-full border p-2 rounded mb-4 h-24"></textarea>
               <div class="flex justify-end gap-2">
                   <button (click)="showNewProjectModal.set(false)" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">取消</button>
                   <button (click)="confirmCreateProject(projName.value, projDesc.value)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">创建</button>
               </div>
           </div>
      </div>
  }

  <!-- GenAI Image Modal -->
    @if(showGenAIModal()) {
      <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center" (click)="showGenAIModal.set(false)">
           <div class="bg-white rounded-2xl shadow-2xl w-[500px] p-6 overflow-hidden flex flex-col max-h-[90vh]" (click)="$event.stopPropagation()">
               <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                   <span class="material-icons text-pink-500">image</span> AI 绘图
               </h2>
               
               <div class="flex-1 overflow-y-auto mb-4 bg-slate-50 rounded p-4 min-h-[200px] flex items-center justify-center">
                   @if (genAiImage()) {
                       <img [src]="genAiImage()" class="max-w-full rounded shadow-lg">
                   } @else {
                       <div class="text-slate-400 text-center">
                           @if(isGenerating()) {
                               <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                               正在生成...
                           } @else {
                               请输入提示词
                           }
                       </div>
                   }
               </div>

               <textarea #imgPrompt placeholder="描述您想要的图像（例如：赛博朋克风格的流程图）" class="w-full border border-slate-300 p-3 rounded-lg mb-4 focus:ring-2 focus:ring-pink-500 focus:outline-none"></textarea>
               
               <div class="flex justify-end gap-2">
                   <button (click)="showGenAIModal.set(false)" class="px-4 py-2 text-slate-600">关闭</button>
                   <button (click)="runImageGen(imgPrompt.value)" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition-colors font-medium" [disabled]="isGenerating()">
                       生成
                   </button>
               </div>
           </div>
      </div>
  }
  
  <!-- Image Editor Modal -->
  @if(showImageEditModal()) {
      <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center" (click)="showImageEditModal.set(false)">
           <div class="bg-white rounded-2xl shadow-2xl w-[600px] p-6 overflow-hidden flex flex-col max-h-[90vh]" (click)="$event.stopPropagation()">
               <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-emerald-600">
                   <span>✨</span> AI 图像编辑
               </h2>
               
               <!-- Upload/Display Area -->
               <div class="flex-1 overflow-y-auto mb-4 bg-slate-100 rounded p-4 min-h-[250px] flex flex-col items-center justify-center relative">
                   @if(editingImage()) {
                       <img [src]="editingImage()" class="max-h-[300px] object-contain rounded shadow mb-2">
                       <button (click)="editingImage.set(null)" class="absolute top-2 right-2 bg-white/80 p-1 rounded-full hover:bg-white text-red-500 font-bold">✕</button>
                   } @else {
                       <div class="text-center">
                           <p class="text-slate-500 mb-2">请上传图片</p>
                           <input type="file" accept="image/*" (change)="onFileSelected($event)" class="text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                       </div>
                   }
               </div>
               
               <div class="mb-4">
                   <label class="block text-sm font-medium text-slate-700 mb-1">编辑指令</label>
                   <input #editPrompt type="text" placeholder="例如：将背景改为星空，增加复古滤镜" class="w-full border border-slate-300 p-2 rounded focus:ring-2 focus:ring-emerald-500 outline-none">
               </div>

               <div class="flex justify-end gap-2">
                   <button (click)="showImageEditModal.set(false)" class="px-4 py-2 text-slate-600">关闭</button>
                   <button (click)="runImageEdit(editPrompt.value)" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium" [disabled]="isGenerating() || !editingImage()">
                       @if(isGenerating()) { 处理中... } @else { 应用编辑 }
                   </button>
               </div>
           </div>
      </div>
  }
</div>
